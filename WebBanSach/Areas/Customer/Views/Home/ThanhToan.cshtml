@model Media.Models.ThanhToan

@section PageStyles {
    <link rel="stylesheet" href="~/css/pages/thanhtoan.css" asp-append-version="true" />
}


<div class="checkout-container">

    @using (Html.BeginForm("ThanhToan", "Home", FormMethod.Post, new { @class = "checkout-form" }))
    {
        @Html.AntiForgeryToken()

        <div class="grid-2col">
            <div class="section">
                <h2 class="section-title-checkout">Địa Chỉ Giao Hàng</h2>

                <div class="form-group">
                    @Html.LabelFor(m => m.HoTen)
                    @Html.TextBoxFor(m => m.HoTen, new { @class = "form-control", placeholder = "Nguyễn Việt Tiến" })
                    @Html.ValidationMessageFor(m => m.HoTen, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.SoDienThoai)
                    @Html.TextBoxFor(m => m.SoDienThoai, new { @class = "form-control", placeholder = "0896899703" })
                    @Html.ValidationMessageFor(m => m.SoDienThoai, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.TinhThanh)
                    @Html.DropDownListFor(m => m.TinhThanh, Model.list_TinhThanh, new { @class = "form-control dropdownlist", id = "provinceSelect" })
                    @Html.ValidationMessageFor(m => m.TinhThanh, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.QuanHuyen)
                    @Html.DropDownListFor(m => m.QuanHuyen, Model.list_QuanHuyen, new { @class = "form-control dropdownlist", id = "districtSelect" })
                    @Html.ValidationMessageFor(m => m.QuanHuyen, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.PhuongXa)
                    @Html.DropDownListFor(m => m.PhuongXa, Model.list_PhuongXa, new { @class = "form-control dropdownlist", id = "wardSelect" })
                    @Html.ValidationMessageFor(m => m.PhuongXa, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.DiaChi)
                    @Html.TextBoxFor(m => m.DiaChi, new { @class = "form-control", placeholder = "Nhập địa chỉ nhận hàng" })
                    @Html.ValidationMessageFor(m => m.DiaChi, "", new { @class = "text-danger" })
                </div>
            </div>

            <!-- Phương thức vận chuyển -->
            <div class="section">
                <h2 class="section-title-checkout">Phương Thức Vận Chuyển</h2>
                <div class="shipping-method">
                    <input type="radio" name="shippingMethod" value="standard" checked />
                    <div class="method-info">
                        <div><strong>Giao hàng tiêu chuẩn: @Model.MienPhiVanChuyen.ToString("N0") đ</strong></div>
                        <div class="method-note">Dự kiến giao: Thứ Năm - 30/10</div>
                    </div>
                </div>
            </div>

            <!-- Kiểm tra lại đơn hàng -->
            <div class="section">
                <h2 class="section-title-checkout">Kiểm Tra Lại Đơn Hàng</h2>
                <div class="product-item">
                    <img src="@Model.HinhAnhSanPham" alt="@Model.TenSanPham" class="product-image" />
                    <div class="product-info-checkout">
                        <span class="product-name-checkout">@Model.TenSanPham</span>
                        <span class="product-price-checkout">@Model.TongTien.ToString("N0") đ</span>
                        <div class="quantity-section-checkout">
                            <label class="quantity-label-checkout">Số lượng: </label>
                            <div class="quantity-control-checkout">
                                <button class="btn-qty-checkout" onclick="decreaseQty()">-</button>
                                <input type="text" id="qtyCheckout" value="1" maxvalue="999" readonly>
                                <button class="btn-qty-checkout" onclick="increaseQty()">+</button>
                            </div>
                        </div>
                        <button class="delete-btn"><i class="fi fi-rs-trash"></i></button>
                    </div>
                </div>
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Thành tiền</span>
                        <span>@Model.TamTinh.ToString("N0") đ</span>
                    </div>
                    <div class="summary-row">
                        <span>Phí vận chuyển (Giao hàng tiêu chuẩn)</span>
                        <span>@Model.MienPhiVanChuyen.ToString("N0") đ</span>
                    </div>
                    <div class="summary-row total">
                        <span>Tổng Số Tiền (gồm VAT)</span>
                        <span>@Model.TongTien.ToString("N0") đ</span>
                    </div>

                    <div class="terms-checkbox">
                        <input type="checkbox" id="termsCheckbox" required />
                        <label for="termsCheckbox">
                            Bằng việc tiến hành Mua hàng, Bạn đã đồng ý với
                            <a href="#" class="invoice-link">Điều khoản & Điều kiện của Fahasa.com</a>
                        </label>
                    </div>

                    <button type="submit" class="btn-submit">Xác nhận thanh toán</button>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        const SHOP_PROVINCE_CODE = "79"; // ví dụ TP.HCM = 79 (bạn có thể chỉnh lại)

        $(document).ready(function () {
            const provinceSelect = $('#provinceSelect');
            const districtSelect = $('#districtSelect');
            const wardSelect = $('#wardSelect');
            const elemEstimate = document.querySelector('.method-note');

            // Ban đầu: disable Quận/Huyện và Phường/Xã
            districtSelect.prop('disabled', true);
            wardSelect.prop('disabled', true);

            // ---- Hàm định dạng ngày dự kiến ----
            function formatEstimatedDate(daysToAdd) {
                const weekdayVN = ['Chủ nhật','Thứ hai','Thứ ba','Thứ tư','Thứ năm','Thứ sáu','Thứ bảy'];
                const now = new Date();
                const est = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysToAdd);
                const weekday = weekdayVN[est.getDay()];
                const dd = String(est.getDate()).padStart(2, '0');
                const mm = String(est.getMonth() + 1).padStart(2, '0');
                return `${weekday} - ${dd}/${mm}`;
            }

            // ---- Cập nhật thời gian giao hàng ----
            function updateDeliveryEstimate(provinceCode) {
                if (!elemEstimate) return;

                if (provinceCode) {
                    const estimatedDays = (provinceCode === SHOP_PROVINCE_CODE) ? 2 : 4;
                    const estimateText = formatEstimatedDate(estimatedDays);
                    $(elemEstimate).fadeOut(150, function () {
                        $(this).html(`Dự kiến giao: <strong>${estimateText}</strong>`).fadeIn(150);
                    });
                } else {
                    $(elemEstimate).fadeOut(150, function () {
                        $(this).html(`Dự kiến giao: <strong>--/--</strong>`).fadeIn(150);
                    });
                }
            }

            // ---- Khi chọn Tỉnh ----
            provinceSelect.change(function () {
                const provinceCode = $(this).val();
                updateDeliveryEstimate(provinceCode); // cập nhật thời gian dự kiến

                if (provinceCode) {
                    districtSelect.prop('disabled', false);
                    wardSelect.prop('disabled', true);

                    $.getJSON('@Url.Action("GetDistricts", "Home")', { provinceCode: provinceCode }, function (data) {
                        districtSelect.empty().append('<option value="">Chọn quận/huyện</option>');
                        $.each(data, function (index, item) {
                            districtSelect.append($('<option></option>').val(item.value).html(item.text));
                        });
                        wardSelect.empty().append('<option value="">Chọn phường/xã</option>');
                    });
                } else {
                    districtSelect.prop('disabled', true).empty().append('<option value="">Chọn quận/huyện</option>');
                    wardSelect.prop('disabled', true).empty().append('<option value="">Chọn phường/xã</option>');
                }
            });

            // ---- Khi chọn Quận/Huyện ----
            districtSelect.change(function () {
                const districtCode = $(this).val();
                if (districtCode) {
                    wardSelect.prop('disabled', false);
                    $.getJSON('@Url.Action("GetWards", "Home")', { districtCode: districtCode }, function (data) {
                        wardSelect.empty().append('<option value="">Chọn phường/xã</option>');
                        $.each(data, function (index, item) {
                            wardSelect.append($('<option></option>').val(item.value).html(item.text));
                        });
                    });
                } else {
                    wardSelect.prop('disabled', true).empty().append('<option value="">Chọn phường/xã</option>');
                }
            });
        });

        // ---- Tăng/giảm số lượng sản phẩm ----
        function increaseQty() {
            const input = document.getElementById('qtyCheckout');
            let value = parseInt(input.value);
            input.value = value + 1;
        }

        function decreaseQty() {
            const input = document.getElementById('qtyCheckout');
            let value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
            }
        }
    </script>
}